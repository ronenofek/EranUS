<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>◊¢◊®"◊ü ‚Äî Test Suite</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Rubik', Arial, sans-serif; background: #f5f5f5; padding: 32px; color: #1C2B26; }
    h1 { font-size: 24px; font-weight: 700; margin-bottom: 6px; color: #134D3A; }
    .subtitle { font-size: 13px; color: #7A9587; margin-bottom: 28px; }
    #summary {
      padding: 16px 20px; border-radius: 12px; margin-bottom: 24px;
      font-size: 15px; font-weight: 600; display: flex; gap: 20px; align-items: center;
    }
    #summary.all-pass { background: #E6F4EF; border: 1px solid #b6deca; color: #134D3A; }
    #summary.has-fail { background: #FDECEA; border: 1px solid #F5C6C2; color: #C0392B; }
    #summary.running  { background: #EBF2FF; border: 1px solid #b8cfef; color: #2E5FA3; }
    .badge { font-size: 13px; font-weight: 700; padding: 3px 10px; border-radius: 20px; }
    .badge-pass { background: #1A6B50; color: #fff; }
    .badge-fail { background: #C0392B; color: #fff; }
    .suite { margin-bottom: 20px; }
    .suite-name {
      font-size: 13px; font-weight: 700; text-transform: uppercase;
      letter-spacing: .6px; color: #4A6559; margin-bottom: 8px;
      padding: 6px 12px; background: #fff; border-radius: 8px;
      border: 1px solid #D0E4DC;
    }
    .test-row {
      padding: 9px 14px; border-radius: 8px; margin-bottom: 4px;
      font-size: 13.5px; display: flex; gap: 10px; align-items: flex-start;
      background: #fff; border: 1px solid #e8e8e8;
    }
    .test-row.pass { border-left: 3px solid #1A6B50; }
    .test-row.fail { border-left: 3px solid #C0392B; background: #fff8f8; }
    .icon { font-size: 15px; flex-shrink: 0; }
    .test-name { flex: 1; }
    .error-msg { font-size: 12px; color: #C0392B; margin-top: 4px; font-family: monospace; }
    .loading { text-align: center; padding: 40px; font-size: 15px; color: #7A9587; }
  </style>
</head>
<body>
  <h1>üß™ ER"AN USA ‚Äî Test Suite</h1>
  <p class="subtitle">Browser-based unit & integration tests for the volunteer portal modules.</p>
  <div id="summary" class="running">‚è≥ Running tests...</div>
  <div id="results"></div>

  <!-- Load all production modules (same order as index.html) -->
  <script src="../data/pdf_data.js"></script>
  <script src="../js/core/config.js"></script>
  <script src="../js/core/storage.js"></script>
  <script src="../js/ui/toast.js"></script>
  <script src="../js/ui/helpers.js"></script>

  <!-- Stub modules that need DOM (auth, app) -->
  <script>
    // Minimal stubs so auth/app modules don't crash without real DOM
    const Auth = { handleLogin(){}, handleLogout(){}, restoreSession(){} };
    const App  = { initApp(){}, showView(){} };
    let currentUser = null;
    let isAdmin = false;
    // Stub Toast so tests don't need #toast element
    const Toast = { show(msg) { console.log('[Toast]', msg); } };
  </script>

  <script src="../js/features/messages/messages.js"></script>
  <script>
    // Minimal stub for Messages.render (needs DOM, skip in tests)
    Messages.render = function() {};
  </script>
  <script src="../js/features/messages/message-admin.js"></script>
  <script src="../js/features/documents/documents.js"></script>
  <script>Docs.render = function() {};</script>
  <script src="../js/features/documents/pdf-viewer.js"></script>
  <script src="../js/features/documents/doc-admin.js"></script>
  <script src="../js/features/admin/admin-panel.js"></script>
  <script>
    AdminPanel.renderLists = function() {};
    AdminPanel.closeConfirm = function() {};
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="../js/features/search/pdf-extractor.js"></script>
  <script src="../js/features/search/search-engine.js"></script>
  <script src="../js/features/search/kolzchut-api.js"></script>
  <script src="../js/features/search/search-modal.js"></script>
  <script>SearchModal.open = function(){}; SearchModal.close = function(){};</script>
  <script src="../js/core/app.js"></script>

  <!-- Test framework -->
  <script src="helpers/test-utils.js"></script>

  <!-- Spec files -->
  <script src="spec/storage.spec.js"></script>
  <script src="spec/auth.spec.js"></script>
  <script src="spec/messages.spec.js"></script>
  <script src="spec/helpers.spec.js"></script>
  <script src="spec/search-engine.spec.js"></script>
  <script src="spec/integration.spec.js"></script>

  <!-- Runner -->
  <script>
  window.addEventListener('load', async () => {
    const res = await runAllTests();
    const total = res.pass + res.fail;
    const sumEl = document.getElementById('summary');
    sumEl.className = 'summary ' + (res.fail === 0 ? 'all-pass' : 'has-fail');
    sumEl.innerHTML = `
      ${res.fail === 0 ? '‚úÖ' : '‚ùå'} ${total} tests
      <span class="badge badge-pass">${res.pass} passed</span>
      ${res.fail > 0 ? `<span class="badge badge-fail">${res.fail} failed</span>` : ''}
    `;

    // Group by suite
    const suites = {};
    res.items.forEach(item => {
      if (!suites[item.suite]) suites[item.suite] = [];
      suites[item.suite].push(item);
    });

    const container = document.getElementById('results');
    for (const [suite, items] of Object.entries(suites)) {
      const div = document.createElement('div');
      div.className = 'suite';
      div.innerHTML = `<div class="suite-name">${suite}</div>`;
      items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'test-row ' + (item.ok ? 'pass' : 'fail');
        row.innerHTML = `
          <span class="icon">${item.ok ? '‚úÖ' : '‚ùå'}</span>
          <div>
            <div class="test-name">${item.name}</div>
            ${item.error ? `<div class="error-msg">${item.error}</div>` : ''}
          </div>
        `;
        div.appendChild(row);
      });
      container.appendChild(div);
    }
  });
  </script>
</body>
</html>
